{% extends "base.html" %}

{% block title %}Document Input - LegalSaathi{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">Universal Legal Document Analysis</h2>
            </div>
            <div class="card-body">
                <!-- Enhanced Problem Statement & Community Impact -->
                <div class="alert alert-info mb-4" role="region" aria-labelledby="problemStatement">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-lightbulb-fill fs-4 me-3 text-primary" aria-hidden="true"></i>
                        <div>
                            <h6 id="problemStatement" class="alert-heading mb-2">Bridging the Legal Literacy Gap</h6>
                            <p class="mb-2">
                                <strong>The Problem:</strong> 78% of people struggle to understand legal documents, leading to unfavorable agreements and financial losses.
                            </p>
                            <p class="mb-0">
                                <strong>Our Solution:</strong> AI-powered analysis that transforms complex legal language into clear, actionable insights - making legal protection accessible to everyone.
                            </p>
                        </div>
                    </div>
                </div>

                <p class="text-muted mb-4">
                    Upload or paste your legal document below to get an AI-powered analysis with risk assessment and
                    plain-language explanations. Supports rental agreements, employment contracts, NDAs, terms of service, loan agreements, and more.
                </p>

                {% if error %}
                <div class="alert alert-danger" role="alert">
                    <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}

                <div id="jsErrorAlert" class="alert alert-danger" role="alert" style="display: none;"></div>

                <form method="POST" action="/analyze" id="documentForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label class="form-label" for="fileUploadArea">
                            <i class="bi bi-cloud-upload me-2"></i>Upload Document (Optional)
                        </label>
                        <div class="file-upload-area" id="fileUploadArea" 
                             role="button" 
                             tabindex="0"
                             aria-label="Upload document by clicking or dragging and dropping"
                             aria-describedby="fileUploadHelp">
                            <div class="file-upload-content" id="fileUploadContent">
                                <i class="bi bi-cloud-upload fs-1 text-muted mb-3" aria-hidden="true"></i>
                                <h5>Drag & Drop Your Document Here</h5>
                                <p class="text-muted mb-3">or click to browse files</p>
                                <input type="file" 
                                       class="form-control" 
                                       id="document_file" 
                                       name="document_file"
                                       accept=".pdf,.txt" 
                                       style="display: none;"
                                       aria-describedby="fileUploadHelp">
                                <button type="button" 
                                        class="btn btn-outline-primary"
                                        onclick="document.getElementById('document_file').click()"
                                        aria-label="Choose file to upload">
                                    <i class="bi bi-folder2-open" aria-hidden="true"></i> Choose File
                                </button>
                                <div class="mt-2" id="fileUploadHelp">
                                    <small class="text-muted">Supported formats: PDF, TXT (Max 10MB)</small>
                                </div>
                            </div>
                            <div class="file-upload-success" id="fileUploadSuccess" style="display: none;" role="status" aria-live="polite">
                                <i class="bi bi-check-circle-fill text-success fs-1 mb-3" aria-hidden="true"></i>
                                <h5 id="uploadedFileName">File uploaded successfully</h5>
                                <p class="text-muted" id="uploadedFileInfo">Ready for analysis</p>
                                <button type="button" 
                                        class="btn btn-outline-secondary btn-sm" 
                                        onclick="clearFile()"
                                        aria-label="Remove uploaded file">
                                    <i class="bi bi-x-circle" aria-hidden="true"></i> Remove File
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="document_text" class="form-label">Or Paste Document Text</label>
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-outline-info btn-sm" id="voiceInputBtn" onclick="startVoiceInput()" title="Voice Input (Google Speech-to-Text)">
                                    <i class="bi bi-mic"></i>
                                    <span class="d-none d-sm-inline ms-1">Voice Input</span>
                                </button>
                                <small class="text-muted">Alternative to file upload</small>
                            </div>
                        </div>
                        <textarea class="form-control" 
                                  id="document_text" 
                                  name="document_text" 
                                  rows="15"
                                  placeholder="Paste your legal document text here (rental agreement, employment contract, NDA, etc.)..." 
                                  minlength="100"
                                  maxlength="50000"
                                  aria-describedby="charCount validationFeedback"
                                  aria-label="Legal document text input">{{ document_text or '' }}</textarea>
                        <div class="form-text">
                            <div class="d-flex flex-column flex-sm-row justify-content-between">
                                <span class="mb-1 mb-sm-0">Please ensure you provide the complete legal document for
                                    accurate analysis.</span>
                                <span id="charCount" class="text-muted char-counter">0 / 50,000 characters</span>
                            </div>
                        </div>
                        <div id="validationFeedback" class="invalid-feedback"></div>
                    </div>

                    <!-- User Expertise Level Selection -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-person-badge me-1"></i>
                            Your Experience Level (Optional)
                        </label>
                        <div class="row">
                            <div class="col-12 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expertise_level" id="beginner" value="beginner" checked>
                                    <label class="form-check-label" for="beginner">
                                        <strong>Beginner</strong>
                                        <small class="d-block text-muted">New to legal documents</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expertise_level" id="intermediate" value="intermediate">
                                    <label class="form-check-label" for="intermediate">
                                        <strong>Intermediate</strong>
                                        <small class="d-block text-muted">Some legal document experience</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expertise_level" id="expert" value="expert">
                                    <label class="form-check-label" for="expert">
                                        <strong>Expert</strong>
                                        <small class="d-block text-muted">Legal/real estate professional</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                This helps us adapt our explanations to your knowledge level
                            </small>
                        </div>
                    </div>

                    <!-- Optional Questions Field -->
                    <div class="mb-4">
                        <label for="user_questions" class="form-label">
                            <i class="bi bi-chat-question me-1"></i>
                            Any Specific Questions? (Optional)
                        </label>
                        <textarea class="form-control" id="user_questions" name="user_questions" rows="2"
                            placeholder="e.g., What does this clause mean? Are these terms fair? What are my rights?"></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                Ask any questions about legal terms or specific clauses you're concerned about
                            </small>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" 
                                class="btn btn-primary btn-lg" 
                                id="analyzeBtn"
                                aria-describedby="analyzeHelp">
                            <i class="bi bi-search" aria-hidden="true"></i> 
                            <span>Analyze Document</span>
                            <span class="sr-only" id="analyzeHelp">Start AI-powered analysis of your legal document</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Demo Mode Section -->
        <div class="mt-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-play-circle me-2"></i>
                        Try Our Demo Mode
                    </h5>
                    <small class="opacity-75">Experience our AI analysis with sample documents</small>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        See how our AI analyzes different types of legal documents. Click any sample below to load it instantly:
                    </p>
                    <div class="row g-3">
                        <div class="col-12 col-md-6 col-lg-4">
                            <button class="btn btn-outline-primary w-100 demo-sample-btn" 
                                    data-sample="rental" 
                                    onclick="loadDemoSample('rental')"
                                    aria-describedby="rentalDemo">
                                <i class="bi bi-house-door me-2"></i>
                                <div>
                                    <strong>Rental Agreement</strong>
                                    <small class="d-block text-muted">Unfavorable lease terms</small>
                                </div>
                            </button>
                            <div id="rentalDemo" class="sr-only">Sample rental agreement with problematic clauses for demonstration</div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <button class="btn btn-outline-success w-100 demo-sample-btn" 
                                    data-sample="employment" 
                                    onclick="loadDemoSample('employment')"
                                    aria-describedby="employmentDemo">
                                <i class="bi bi-briefcase me-2"></i>
                                <div>
                                    <strong>Employment Contract</strong>
                                    <small class="d-block text-muted">Standard terms</small>
                                </div>
                            </button>
                            <div id="employmentDemo" class="sr-only">Sample employment contract with standard terms for demonstration</div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <button class="btn btn-outline-warning w-100 demo-sample-btn" 
                                    data-sample="nda" 
                                    onclick="loadDemoSample('nda')"
                                    aria-describedby="ndaDemo">
                                <i class="bi bi-shield-lock me-2"></i>
                                <div>
                                    <strong>NDA Agreement</strong>
                                    <small class="d-block text-muted">Overly broad terms</small>
                                </div>
                            </button>
                            <div id="ndaDemo" class="sr-only">Sample NDA with overly broad confidentiality terms for demonstration</div>
                        </div>
                    </div>
                    <div class="alert alert-light mt-3">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Demo Benefits:</strong> See real AI analysis • Understand risk levels • Experience plain-language explanations
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Walkthrough -->
        <div class="mt-4">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-compass me-2"></i>
                        Interactive Walkthrough
                    </h5>
                    <small class="opacity-75">Learn how our AI-powered legal guidance works</small>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-12 col-md-8">
                            <p class="mb-3">
                                New to legal document analysis? Take our guided tour to understand how AI can protect your interests.
                            </p>
                            <ul class="list-unstyled mb-3">
                                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Learn about risk assessment</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Understand confidence indicators</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>See plain-language explanations</li>
                                <li class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>Discover actionable recommendations</li>
                            </ul>
                        </div>
                        <div class="col-12 col-md-4 text-center">
                            <button class="btn btn-info btn-lg" onclick="startWalkthrough()" aria-describedby="walkthroughHelp">
                                <i class="bi bi-play-fill me-2"></i>
                                Start Tour
                            </button>
                            <div id="walkthroughHelp" class="sr-only">Interactive walkthrough of AI legal document analysis features</div>
                            <small class="d-block text-muted mt-2">~3 minutes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-cpu-fill text-primary me-2"></i>
                        AI-Powered Analysis Process:
                    </h5>
                    <div class="alert alert-light mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-google text-primary fs-4 me-3"></i>
                            <div>
                                <strong>Powered by Google Cloud AI</strong>
                                <small class="d-block text-muted">Advanced machine learning models for accurate legal document analysis</small>
                            </div>
                        </div>
                    </div>
                    <ol class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-start border-0 px-0 py-3">
                            <span class="badge bg-primary rounded-pill me-3 mt-1">1</span>
                            <div>
                                <strong>Document Upload & Processing</strong>
                                <p class="text-muted mb-1 small">Upload or paste your legal document text in the box above</p>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-primary" style="width: 20%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-start border-0 px-0 py-3">
                            <span class="badge bg-info rounded-pill me-3 mt-1">2</span>
                            <div>
                                <strong>AI Analysis with Google Cloud</strong>
                                <p class="text-muted mb-1 small">Advanced NLP models analyze document structure and identify key clauses</p>
                                <div class="d-flex align-items-center mt-2">
                                    <i class="bi bi-shield-check text-success me-2"></i>
                                    <small class="text-muted">Confidence scoring • Risk categorization • Pattern recognition</small>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-info" style="width: 40%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-start border-0 px-0 py-3">
                            <span class="badge bg-warning rounded-pill me-3 mt-1">3</span>
                            <div>
                                <strong>Risk Assessment & Traffic Light System</strong>
                                <p class="text-muted mb-1 small">Review color-coded risk levels with confidence indicators</p>
                                <div class="d-flex align-items-center mt-2">
                                    <span class="traffic-light red me-2" title="High Risk"></span>
                                    <span class="traffic-light yellow me-2" title="Moderate Risk"></span>
                                    <span class="traffic-light green me-2" title="Low Risk"></span>
                                    <small class="text-muted ms-2">Visual risk indicators with confidence percentages</small>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-warning" style="width: 60%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-start border-0 px-0 py-3">
                            <span class="badge bg-success rounded-pill me-3 mt-1">4</span>
                            <div>
                                <strong>Plain-Language Explanations</strong>
                                <p class="text-muted mb-1 small">Complex legal terms translated into clear, understandable language</p>
                                <div class="alert alert-light py-2 mt-2">
                                    <small><strong>Example:</strong> "Liquidated damages" → "Fixed penalty amount you must pay if you break the contract"</small>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: 80%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-start border-0 px-0 py-3">
                            <span class="badge bg-dark rounded-pill me-3 mt-1">5</span>
                            <div>
                                <strong>Actionable Recommendations</strong>
                                <p class="text-muted mb-1 small">Specific steps to protect your interests and improve terms</p>
                                <div class="d-flex align-items-center mt-2">
                                    <i class="bi bi-lightbulb text-warning me-2"></i>
                                    <small class="text-muted">Negotiation tips • Legal alternatives • Professional consultation guidance</small>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-dark" style="width: 100%"></div>
                                </div>
                            </div>
                        </li>
                    </ol>
                    
                    <!-- AI Transparency & Trust Indicators -->
                    <div class="alert alert-info mt-4">
                        <h6 class="alert-heading">
                            <i class="bi bi-shield-check me-2"></i>
                            AI Transparency & Trust
                        </h6>
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-1"><i class="bi bi-check-circle text-success me-2"></i><strong>Confidence Scoring:</strong> Every analysis includes confidence percentages</li>
                                    <li class="mb-1"><i class="bi bi-check-circle text-success me-2"></i><strong>Result Variability:</strong> Clear indicators when results may vary</li>
                                </ul>
                            </div>
                            <div class="col-12 col-md-6">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-1"><i class="bi bi-check-circle text-success me-2"></i><strong>Progressive Disclosure:</strong> Information revealed as needed</li>
                                    <li class="mb-0"><i class="bi bi-check-circle text-success me-2"></i><strong>Human Oversight:</strong> Always recommend professional review for critical decisions</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Demo sample documents
    const demoSamples = {
        rental: `RESIDENTIAL LEASE AGREEMENT

This Lease Agreement is entered into between ABC Property Management ("Landlord") and Tenant.

TERMS AND CONDITIONS:

1. RENT: Tenant agrees to pay $2,500 per month, due on the 1st of each month. Late fees of $150 will be charged for payments received after the 3rd day of the month.

2. SECURITY DEPOSIT: Tenant must pay a security deposit of $5,000, which may be used by Landlord for any damages, unpaid rent, or cleaning fees at Landlord's sole discretion.

3. MAINTENANCE: Tenant is responsible for ALL maintenance and repairs, including major structural repairs, HVAC systems, and appliances, regardless of cause.

4. TERMINATION: Landlord may terminate this lease at any time with 24 hours written notice for any reason or no reason. Tenant must give 60 days notice to terminate.

5. LIABILITY: Tenant assumes all liability for any injuries or damages occurring on the premises, including those caused by Landlord's negligence.

6. MODIFICATIONS: Landlord may modify lease terms at any time with 7 days notice. Tenant's continued occupancy constitutes acceptance of modifications.

7. SUBLETTING: Subletting is strictly prohibited. Violation results in immediate eviction and forfeiture of all deposits.

8. ENTRY: Landlord may enter premises at any time without notice for inspections, repairs, or showing to prospective tenants.`,

        employment: `EMPLOYMENT AGREEMENT

This Employment Agreement is between TechCorp Inc. ("Company") and Employee.

EMPLOYMENT TERMS:

1. POSITION: Employee is hired as Software Developer, reporting to the Engineering Manager.

2. COMPENSATION: Annual salary of $85,000, paid bi-weekly. Performance reviews conducted annually with potential for merit increases.

3. BENEFITS: Health insurance (Company pays 80%), dental and vision coverage, 401(k) with 4% company match, 15 days PTO annually.

4. WORK SCHEDULE: Standard 40-hour work week, Monday-Friday, 9 AM to 5 PM. Flexible work arrangements may be available with supervisor approval.

5. CONFIDENTIALITY: Employee agrees to maintain confidentiality of proprietary information and trade secrets during and after employment.

6. TERMINATION: Either party may terminate employment with two weeks written notice. Company may terminate immediately for cause.

7. INTELLECTUAL PROPERTY: Work-related inventions and developments belong to Company. Employee retains rights to pre-existing personal projects.

8. NON-COMPETE: Employee agrees not to work for direct competitors for 6 months after termination within the same geographic region.`,

        nda: `NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement is between MegaCorp Industries ("Disclosing Party") and Recipient.

CONFIDENTIALITY TERMS:

1. DEFINITION OF CONFIDENTIAL INFORMATION: All information, data, materials, products, technology, computer programs, software, marketing plans, customer lists, financial information, and any other business information disclosed by Disclosing Party.

2. SCOPE: Recipient agrees that ANY information learned, observed, or accessed during any interaction with Disclosing Party shall be considered confidential, including publicly available information.

3. OBLIGATIONS: Recipient shall not disclose, use, copy, or distribute any confidential information for ANY purpose, including personal use, competitive analysis, or general knowledge.

4. DURATION: This agreement remains in effect INDEFINITELY, even after termination of business relationship.

5. RETURN OF MATERIALS: Upon request, Recipient must immediately return or destroy all materials, including any notes, copies, or derivative works, and provide written certification of destruction.

6. REMEDIES: Breach of this agreement will result in immediate injunctive relief and monetary damages of no less than $100,000, plus attorney fees and costs.

7. BROAD INTERPRETATION: Any doubt about whether information is confidential shall be resolved in favor of confidentiality.

8. SURVIVAL: All obligations survive termination of any business relationship and bind Recipient's heirs, successors, and assigns.`
    };

    // Load demo sample function
    window.loadDemoSample = function(sampleType) {
        const documentText = document.getElementById('document_text');
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        if (demoSamples[sampleType]) {
            // Clear any uploaded file
            clearFile();
            
            // Load sample text
            documentText.value = demoSamples[sampleType];
            
            // Update character count and validation
            updateCharCount();
            validateDocumentText();
            
            // Scroll to the text area
            documentText.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Add visual feedback
            documentText.classList.add('success-bounce');
            setTimeout(() => {
                documentText.classList.remove('success-bounce');
            }, 600);
            
            // Show notification
            if (typeof showNotification === 'function') {
                const sampleNames = {
                    rental: 'Rental Agreement',
                    employment: 'Employment Contract', 
                    nda: 'NDA Agreement'
                };
                showNotification(`${sampleNames[sampleType]} sample loaded successfully!`, 'success');
            }
            
            // Update demo button states
            document.querySelectorAll('.demo-sample-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-success', 'btn-warning');
                const sample = btn.dataset.sample;
                if (sample === 'rental') btn.classList.add('btn-outline-primary');
                else if (sample === 'employment') btn.classList.add('btn-outline-success');
                else if (sample === 'nda') btn.classList.add('btn-outline-warning');
            });
            
            // Highlight selected button
            const selectedBtn = document.querySelector(`[data-sample="${sampleType}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning');
                if (sampleType === 'rental') selectedBtn.classList.add('btn-primary');
                else if (sampleType === 'employment') selectedBtn.classList.add('btn-success');
                else if (sampleType === 'nda') selectedBtn.classList.add('btn-warning');
            }
        }
    };

    // Voice Input Functionality using Google Cloud Speech-to-Text
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    window.startVoiceInput = function() {
        const voiceBtn = document.getElementById('voiceInputBtn');
        
        if (!isRecording) {
            // Start recording
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await processVoiceInput(audioBlob);
                        
                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    // Update button state
                    voiceBtn.innerHTML = '<i class="bi bi-stop-fill text-danger"></i><span class="d-none d-sm-inline ms-1">Stop Recording</span>';
                    voiceBtn.classList.remove('btn-outline-info');
                    voiceBtn.classList.add('btn-danger');
                    
                    // Show recording indicator
                    showRecordingIndicator();
                    
                    // Auto-stop after 30 seconds
                    setTimeout(() => {
                        if (isRecording) {
                            stopVoiceInput();
                        }
                    }, 30000);
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    if (typeof showNotification === 'function') {
                        showNotification('Microphone access denied. Please enable microphone permissions.', 'warning');
                    } else {
                        alert('Microphone access denied. Please enable microphone permissions.');
                    }
                });
        } else {
            stopVoiceInput();
        }
    };

    function stopVoiceInput() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            
            const voiceBtn = document.getElementById('voiceInputBtn');
            voiceBtn.innerHTML = '<i class="bi bi-mic"></i><span class="d-none d-sm-inline ms-1">Voice Input</span>';
            voiceBtn.classList.remove('btn-danger');
            voiceBtn.classList.add('btn-outline-info');
            
            hideRecordingIndicator();
        }
    }

    function showRecordingIndicator() {
        // Create recording indicator
        const indicator = document.createElement('div');
        indicator.id = 'recordingIndicator';
        indicator.className = 'alert alert-info d-flex align-items-center';
        indicator.innerHTML = `
            <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status">
                <span class="sr-only">Recording...</span>
            </div>
            <div>
                <strong>Recording in progress...</strong>
                <small class="d-block">Speak clearly about your legal document. Click "Stop Recording" when finished.</small>
            </div>
        `;
        
        // Insert before the textarea
        const textArea = document.getElementById('document_text');
        textArea.parentNode.insertBefore(indicator, textArea);
    }

    function hideRecordingIndicator() {
        const indicator = document.getElementById('recordingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }

    async function processVoiceInput(audioBlob) {
        try {
            // Show processing indicator
            const processingIndicator = document.createElement('div');
            processingIndicator.id = 'processingIndicator';
            processingIndicator.className = 'alert alert-primary d-flex align-items-center';
            processingIndicator.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                    <span class="sr-only">Processing...</span>
                </div>
                <div>
                    <strong>Processing speech with Google Cloud AI...</strong>
                    <small class="d-block">Converting your voice to text using advanced speech recognition.</small>
                </div>
            `;
            
            const textArea = document.getElementById('document_text');
            textArea.parentNode.insertBefore(processingIndicator, textArea);
            
            // Prepare form data
            const formData = new FormData();
            formData.append('audio', audioBlob);
            formData.append('language_code', 'en-US'); // Could be made configurable
            
            // Send to Google Cloud Speech-to-Text API
            const response = await fetch('/api/speech-to-text', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // Remove processing indicator
            processingIndicator.remove();
            
            if (result.success && result.transcript) {
                // Add transcribed text to textarea
                const currentText = textArea.value;
                const newText = currentText ? currentText + '\n\n' + result.transcript : result.transcript;
                textArea.value = newText;
                
                // Update character count and validation
                updateCharCount();
                validateDocumentText();
                
                // Show success notification
                if (typeof showNotification === 'function') {
                    showNotification(`Voice input successful! Transcribed ${result.transcript.length} characters.`, 'success');
                }
                
                // Show confidence and quality info
                if (result.confidence) {
                    const confidenceAlert = document.createElement('div');
                    confidenceAlert.className = 'alert alert-info alert-dismissible fade show mt-2';
                    confidenceAlert.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi bi-google text-primary me-2"></i>
                            <div>
                                <strong>Google Cloud Speech Recognition:</strong>
                                <small class="d-block">Confidence: ${Math.round(result.confidence * 100)}% | Quality: ${result.quality_assessment?.overall_quality || 'Good'}</small>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    textArea.parentNode.insertBefore(confidenceAlert, textArea.nextSibling);
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        if (confidenceAlert.parentNode) {
                            confidenceAlert.remove();
                        }
                    }, 5000);
                }
                
            } else {
                // Show error
                const errorMsg = result.error || 'Speech recognition failed. Please try again.';
                if (typeof showNotification === 'function') {
                    showNotification(errorMsg, 'warning');
                } else {
                    alert(errorMsg);
                }
            }
            
        } catch (error) {
            console.error('Voice input processing error:', error);
            
            // Remove processing indicator
            const processingIndicator = document.getElementById('processingIndicator');
            if (processingIndicator) {
                processingIndicator.remove();
            }
            
            if (typeof showNotification === 'function') {
                showNotification('Voice processing failed. Please try again or use text input.', 'danger');
            } else {
                alert('Voice processing failed. Please try again or use text input.');
            }
        }
    }

    // Interactive walkthrough function
    window.startWalkthrough = function() {
        // Create walkthrough overlay
        const walkthroughOverlay = document.createElement('div');
        walkthroughOverlay.className = 'walkthrough-overlay';
        walkthroughOverlay.innerHTML = `
            <div class="walkthrough-content">
                <div class="walkthrough-header">
                    <h4><i class="bi bi-compass me-2"></i>LegalSaathi AI Walkthrough</h4>
                    <button class="btn-close" onclick="closeWalkthrough()" aria-label="Close walkthrough"></button>
                </div>
                <div class="walkthrough-body">
                    <div class="walkthrough-step active" data-step="1">
                        <div class="step-indicator">
                            <span class="step-number">1</span>
                            <span class="step-title">Welcome to AI Legal Analysis</span>
                        </div>
                        <div class="step-content">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5>Protecting Your Legal Interests</h5>
                                    <p>LegalSaathi uses advanced AI to analyze legal documents and identify potential risks that could cost you money or legal problems.</p>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-shield-check text-success me-2"></i>78% of people miss important legal risks</li>
                                        <li><i class="bi bi-cpu text-primary me-2"></i>Our AI catches what humans often miss</li>
                                        <li><i class="bi bi-translate text-info me-2"></i>Plain language explanations for everyone</li>
                                    </ul>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="demo-visual">
                                        <i class="bi bi-shield-exclamation text-warning" style="font-size: 4rem;"></i>
                                        <p class="text-muted mt-2">Legal documents can hide costly risks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="walkthrough-step" data-step="2">
                        <div class="step-indicator">
                            <span class="step-number">2</span>
                            <span class="step-title">Traffic Light Risk System</span>
                        </div>
                        <div class="step-content">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5>Easy-to-Understand Risk Levels</h5>
                                    <p>Our traffic light system makes it simple to understand which clauses need your attention:</p>
                                    <div class="risk-examples mt-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="traffic-light red me-3"></span>
                                            <div>
                                                <strong>RED - High Risk</strong>
                                                <small class="d-block text-muted">Immediate attention required</small>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="traffic-light yellow me-3"></span>
                                            <div>
                                                <strong>YELLOW - Moderate Risk</strong>
                                                <small class="d-block text-muted">Review and consider changes</small>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="traffic-light green me-3"></span>
                                            <div>
                                                <strong>GREEN - Low Risk</strong>
                                                <small class="d-block text-muted">Standard, acceptable terms</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="demo-visual">
                                        <div class="traffic-light-demo">
                                            <span class="traffic-light-large red mb-3"></span>
                                            <p class="text-muted">Visual indicators you can trust</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="walkthrough-step" data-step="3">
                        <div class="step-indicator">
                            <span class="step-number">3</span>
                            <span class="step-title">AI Confidence & Transparency</span>
                        </div>
                        <div class="step-content">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5>Transparent AI Analysis</h5>
                                    <p>We believe in AI transparency. Every analysis includes:</p>
                                    <ul class="list-unstyled mt-3">
                                        <li class="mb-2">
                                            <i class="bi bi-percent text-primary me-2"></i>
                                            <strong>Confidence Scores:</strong> How certain our AI is about each assessment
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                            <strong>Variability Warnings:</strong> When results might vary or need human review
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-google text-success me-2"></i>
                                            <strong>Google Cloud AI:</strong> Powered by advanced machine learning models
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="demo-visual">
                                        <div class="confidence-demo">
                                            <div class="badge bg-success mb-2">Confidence: 87%</div>
                                            <div class="badge bg-warning">⚠️ Low Confidence: 45%</div>
                                            <p class="text-muted mt-2 small">Always know how confident our AI is</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="walkthrough-step" data-step="4">
                        <div class="step-indicator">
                            <span class="step-number">4</span>
                            <span class="step-title">Plain Language Explanations</span>
                        </div>
                        <div class="step-content">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5>Legal Jargon Made Simple</h5>
                                    <p>Complex legal terms are automatically translated into language everyone can understand:</p>
                                    <div class="translation-example mt-3">
                                        <div class="alert alert-light">
                                            <strong>Legal Term:</strong> "Liquidated damages clause"<br>
                                            <strong>Plain English:</strong> "Fixed penalty amount you must pay if you break the contract"
                                        </div>
                                        <div class="alert alert-light">
                                            <strong>Legal Term:</strong> "Indemnification provision"<br>
                                            <strong>Plain English:</strong> "You agree to pay for any legal problems caused by your actions"
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="demo-visual">
                                        <i class="bi bi-translate text-info" style="font-size: 4rem;"></i>
                                        <p class="text-muted mt-2">Complex → Simple</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="walkthrough-step" data-step="5">
                        <div class="step-indicator">
                            <span class="step-number">5</span>
                            <span class="step-title">Ready to Get Started</span>
                        </div>
                        <div class="step-content">
                            <div class="text-center">
                                <h5>You're Ready to Analyze Documents!</h5>
                                <p class="mb-4">Now you understand how our AI protects your legal interests. Try it with a sample document or upload your own.</p>
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                            <button class="btn btn-primary btn-lg" onclick="closeWalkthrough(); loadDemoSample('rental');">
                                                <i class="bi bi-play-fill me-2"></i>Try Demo
                                            </button>
                                            <button class="btn btn-outline-primary btn-lg" onclick="closeWalkthrough(); document.getElementById('document_text').focus();">
                                                <i class="bi bi-upload me-2"></i>Upload Document
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="walkthrough-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-secondary" onclick="previousStep()" id="prevBtn" disabled>
                            <i class="bi bi-arrow-left me-2"></i>Previous
                        </button>
                        <div class="step-progress">
                            <span class="current-step">1</span> of <span class="total-steps">5</span>
                        </div>
                        <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                            Next<i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(walkthroughOverlay);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        
        // Announce to screen readers
        if (typeof announceToScreenReader === 'function') {
            announceToScreenReader('Interactive walkthrough started');
        }
    };

    // Walkthrough navigation functions
    window.nextStep = function() {
        const currentStep = document.querySelector('.walkthrough-step.active');
        const currentStepNum = parseInt(currentStep.dataset.step);
        const nextStepNum = currentStepNum + 1;
        const nextStep = document.querySelector(`[data-step="${nextStepNum}"]`);
        
        if (nextStep) {
            currentStep.classList.remove('active');
            nextStep.classList.add('active');
            
            // Update progress
            document.querySelector('.current-step').textContent = nextStepNum;
            
            // Update buttons
            document.getElementById('prevBtn').disabled = false;
            if (nextStepNum === 5) {
                document.getElementById('nextBtn').style.display = 'none';
            }
        }
    };

    window.previousStep = function() {
        const currentStep = document.querySelector('.walkthrough-step.active');
        const currentStepNum = parseInt(currentStep.dataset.step);
        const prevStepNum = currentStepNum - 1;
        const prevStep = document.querySelector(`[data-step="${prevStepNum}"]`);
        
        if (prevStep) {
            currentStep.classList.remove('active');
            prevStep.classList.add('active');
            
            // Update progress
            document.querySelector('.current-step').textContent = prevStepNum;
            
            // Update buttons
            document.getElementById('prevBtn').disabled = prevStepNum === 1;
            document.getElementById('nextBtn').style.display = 'block';
        }
    };

    window.closeWalkthrough = function() {
        const overlay = document.querySelector('.walkthrough-overlay');
        if (overlay) {
            overlay.remove();
        }
        
        // Restore body scroll
        document.body.style.overflow = '';
        
        // Announce to screen readers
        if (typeof announceToScreenReader === 'function') {
            announceToScreenReader('Walkthrough closed');
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        // --- DOM ELEMENT SELECTORS ---
        const form = document.getElementById('documentForm');
        const documentText = document.getElementById('document_text');
        const fileInput = document.getElementById('document_file');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const charCount = document.getElementById('charCount');
        const validationFeedback = document.getElementById('validationFeedback');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileUploadContent = document.getElementById('fileUploadContent');
        const fileUploadSuccess = document.getElementById('fileUploadSuccess');
        const uploadedFileName = document.getElementById('uploadedFileName');
        const uploadedFileInfo = document.getElementById('uploadedFileInfo');
        const jsErrorAlert = document.getElementById('jsErrorAlert');

        // --- HELPER FUNCTIONS (PRESERVED FROM YOUR CODE) ---
        function updateCharCount() {
            const length = documentText.value.length;
            charCount.textContent = `${length.toLocaleString()} / 50,000 characters`;
            charCount.classList.remove('text-muted', 'text-warning', 'text-danger');
            if (length > 50000) charCount.classList.add('text-danger');
            else if (length > 45000) charCount.classList.add('text-warning');
            else charCount.classList.add('text-muted');
        }

        function validateDocumentText() {
            const text = documentText.value.trim();
            documentText.classList.remove('is-invalid', 'is-valid');
            validationFeedback.textContent = '';
            if (text.length === 0) return false;
            if (text.length < 100) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'Document text must be at least 100 characters.';
                return false;
            }
            if (text.length > 50000) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'Document text exceeds 50,000 characters.';
                return false;
            }
            const keywords = ['agreement', 'contract', 'party', 'parties', 'terms', 'conditions', 'shall', 'legal'];
            const found = keywords.filter(k => text.toLowerCase().includes(k));
            if (found.length < 2) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'This doesn\'t appear to be a legal document.';
                return false;
            }
            documentText.classList.add('is-valid');
            return true;
        }

        function handleFileSelection(file) {
            const maxSize = 10 * 1024 * 1024;
            const allowedExtensions = ['.pdf', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                showFileError('Please select a PDF or TXT file.');
                return;
            }
            if (file.size > maxSize) {
                showFileError('File size must be less than 10MB.');
                return;
            }
            if (file.size === 0) {
                showFileError('File appears to be empty.');
                return;
            }
            showFileSuccess(file);
            documentText.value = '';
            updateCharCount();
            documentText.classList.remove('is-invalid', 'is-valid');
        }

        function showFileSuccess(file) {
            fileUploadContent.style.display = 'none';
            fileUploadSuccess.style.display = 'block';
            uploadedFileName.textContent = file.name;
            const sizeText = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
            uploadedFileInfo.textContent = `${sizeText} • Ready for analysis`;
            fileUploadArea.classList.remove('error');
        }

        function showFileError(message) {
            alert(message); // Simple alert for errors
            clearFile();
        }

        window.clearFile = function () {
            fileInput.value = '';
            fileUploadContent.style.display = 'block';
            fileUploadSuccess.style.display = 'none';
        };

        // --- EVENT LISTENERS (PRESERVED FROM YOUR CODE) ---
        documentText.addEventListener('input', () => { updateCharCount(); validateDocumentText(); });
        fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
        fileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadArea.classList.remove('dragover'); });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileSelection(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelection(e.target.files[0]);
        });
        
        // --- *** KEY CHANGE: CONSOLIDATED ASYNC FORM SUBMISSION *** ---
        form.addEventListener('submit', async function (e) {
            // 1. ALWAYS prevent the default browser submission
            e.preventDefault();
            jsErrorAlert.style.display = 'none';

            // 2. Perform final validation check
            const hasFile = fileInput.files.length > 0;
            const hasText = documentText.value.trim().length > 0;
            
            if (!hasFile && !hasText) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'Please either upload a file or paste document text.';
                documentText.focus();
                return;
            }
            if (hasText && !validateDocumentText()) {
                documentText.focus();
                return;
            }
            
            // 3. Show loading state (assumes showLoading() is in a global script like app.js)
            showLoading();
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Analyzing...`;

            // 4. Create FormData and send the request via fetch
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // 5. Success: The backend sent the results page. Replace current page content.
                    const resultHtml = await response.text();
                    document.open();
                    document.write(resultHtml);
                    document.close();
                } else {
                    // 6. Server Error: Display the error from the server.
                    const errorText = await response.text();
                    jsErrorAlert.textContent = `Analysis failed: ${errorText}`;
                    jsErrorAlert.style.display = 'block';
                    hideLoading(); // Hide spinner on error
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="bi bi-search"></i> Analyze Document';
                }
            } catch (error) {
                // 7. Network Error: Handle cases where the server can't be reached.
                console.error('Submission Fetch Error:', error);
                jsErrorAlert.textContent = 'A network error occurred. Please check your connection and try again.';
                jsErrorAlert.style.display = 'block';
                hideLoading(); // Hide spinner on error
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="bi bi-search"></i> Analyze Document';
            }
        });

        // Initial state setup
        updateCharCount();
    });
</script>
{% endblock %}