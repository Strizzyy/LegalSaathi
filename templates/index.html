{% extends "base.html" %}

{% block title %}Document Input - LegalSaathi{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">Universal Legal Document Analysis</h2>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Upload or paste your legal document below to get an AI-powered analysis with risk assessment and
                    plain-language explanations. Supports rental agreements, employment contracts, NDAs, terms of service, loan agreements, and more.
                </p>

                {% if error %}
                <div class="alert alert-danger" role="alert">
                    <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}

                <div id="jsErrorAlert" class="alert alert-danger" role="alert" style="display: none;"></div>

                <form method="POST" action="/analyze" id="documentForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label class="form-label" for="fileUploadArea">
                            <i class="bi bi-cloud-upload me-2"></i>Upload Document (Optional)
                        </label>
                        <div class="file-upload-area" id="fileUploadArea" 
                             role="button" 
                             tabindex="0"
                             aria-label="Upload document by clicking or dragging and dropping"
                             aria-describedby="fileUploadHelp">
                            <div class="file-upload-content" id="fileUploadContent">
                                <i class="bi bi-cloud-upload fs-1 text-muted mb-3" aria-hidden="true"></i>
                                <h5>Drag & Drop Your Document Here</h5>
                                <p class="text-muted mb-3">or click to browse files</p>
                                <input type="file" 
                                       class="form-control" 
                                       id="document_file" 
                                       name="document_file"
                                       accept=".pdf,.txt" 
                                       style="display: none;"
                                       aria-describedby="fileUploadHelp">
                                <button type="button" 
                                        class="btn btn-outline-primary"
                                        onclick="document.getElementById('document_file').click()"
                                        aria-label="Choose file to upload">
                                    <i class="bi bi-folder2-open" aria-hidden="true"></i> Choose File
                                </button>
                                <div class="mt-2" id="fileUploadHelp">
                                    <small class="text-muted">Supported formats: PDF, TXT (Max 10MB)</small>
                                </div>
                            </div>
                            <div class="file-upload-success" id="fileUploadSuccess" style="display: none;" role="status" aria-live="polite">
                                <i class="bi bi-check-circle-fill text-success fs-1 mb-3" aria-hidden="true"></i>
                                <h5 id="uploadedFileName">File uploaded successfully</h5>
                                <p class="text-muted" id="uploadedFileInfo">Ready for analysis</p>
                                <button type="button" 
                                        class="btn btn-outline-secondary btn-sm" 
                                        onclick="clearFile()"
                                        aria-label="Remove uploaded file">
                                    <i class="bi bi-x-circle" aria-hidden="true"></i> Remove File
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="document_text" class="form-label">Or Paste Document Text</label>
                            <small class="text-muted">Alternative to file upload</small>
                        </div>
                        <textarea class="form-control" 
                                  id="document_text" 
                                  name="document_text" 
                                  rows="15"
                                  placeholder="Paste your legal document text here (rental agreement, employment contract, NDA, etc.)..." 
                                  minlength="100"
                                  maxlength="50000"
                                  aria-describedby="charCount validationFeedback"
                                  aria-label="Legal document text input">{{ document_text or '' }}</textarea>
                        <div class="form-text">
                            <div class="d-flex flex-column flex-sm-row justify-content-between">
                                <span class="mb-1 mb-sm-0">Please ensure you provide the complete legal document for
                                    accurate analysis.</span>
                                <span id="charCount" class="text-muted char-counter">0 / 50,000 characters</span>
                            </div>
                        </div>
                        <div id="validationFeedback" class="invalid-feedback"></div>
                    </div>

                    <!-- User Expertise Level Selection -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-person-badge me-1"></i>
                            Your Experience Level (Optional)
                        </label>
                        <div class="row">
                            <div class="col-12 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expertise_level" id="beginner" value="beginner" checked>
                                    <label class="form-check-label" for="beginner">
                                        <strong>Beginner</strong>
                                        <small class="d-block text-muted">New to legal documents</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expertise_level" id="intermediate" value="intermediate">
                                    <label class="form-check-label" for="intermediate">
                                        <strong>Intermediate</strong>
                                        <small class="d-block text-muted">Some legal document experience</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expertise_level" id="expert" value="expert">
                                    <label class="form-check-label" for="expert">
                                        <strong>Expert</strong>
                                        <small class="d-block text-muted">Legal/real estate professional</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                This helps us adapt our explanations to your knowledge level
                            </small>
                        </div>
                    </div>

                    <!-- Optional Questions Field -->
                    <div class="mb-4">
                        <label for="user_questions" class="form-label">
                            <i class="bi bi-chat-question me-1"></i>
                            Any Specific Questions? (Optional)
                        </label>
                        <textarea class="form-control" id="user_questions" name="user_questions" rows="2"
                            placeholder="e.g., What does this clause mean? Are these terms fair? What are my rights?"></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                Ask any questions about legal terms or specific clauses you're concerned about
                            </small>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" 
                                class="btn btn-primary btn-lg" 
                                id="analyzeBtn"
                                aria-describedby="analyzeHelp">
                            <i class="bi bi-search" aria-hidden="true"></i> 
                            <span>Analyze Document</span>
                            <span class="sr-only" id="analyzeHelp">Start AI-powered analysis of your legal document</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-info-circle text-primary me-2"></i>
                        How it works:
                    </h5>
                    <ol class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-center border-0 px-0">
                            <span class="badge bg-primary rounded-pill me-3">1</span>
                            <span>Upload or paste your legal document text in the box above</span>
                        </li>
                        <li class="list-group-item d-flex align-items-center border-0 px-0">
                            <span class="badge bg-primary rounded-pill me-3">2</span>
                            <span>Click "Analyze Document" to start the AI analysis</span>
                        </li>
                        <li class="list-group-item d-flex align-items-center border-0 px-0">
                            <span class="badge bg-primary rounded-pill me-3">3</span>
                            <span>Review the risk assessment with our traffic light system</span>
                        </li>
                        <li class="list-group-item d-flex align-items-center border-0 px-0">
                            <span class="badge bg-primary rounded-pill me-3">4</span>
                            <span>Read plain-language explanations of complex clauses</span>
                        </li>
                        <li class="list-group-item d-flex align-items-center border-0 px-0">
                            <span class="badge bg-primary rounded-pill me-3">5</span>
                            <span>Get actionable recommendations for your situation</span>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DOM ELEMENT SELECTORS ---
        const form = document.getElementById('documentForm');
        const documentText = document.getElementById('document_text');
        const fileInput = document.getElementById('document_file');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const charCount = document.getElementById('charCount');
        const validationFeedback = document.getElementById('validationFeedback');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileUploadContent = document.getElementById('fileUploadContent');
        const fileUploadSuccess = document.getElementById('fileUploadSuccess');
        const uploadedFileName = document.getElementById('uploadedFileName');
        const uploadedFileInfo = document.getElementById('uploadedFileInfo');
        const jsErrorAlert = document.getElementById('jsErrorAlert');

        // --- HELPER FUNCTIONS (PRESERVED FROM YOUR CODE) ---
        function updateCharCount() {
            const length = documentText.value.length;
            charCount.textContent = `${length.toLocaleString()} / 50,000 characters`;
            charCount.classList.remove('text-muted', 'text-warning', 'text-danger');
            if (length > 50000) charCount.classList.add('text-danger');
            else if (length > 45000) charCount.classList.add('text-warning');
            else charCount.classList.add('text-muted');
        }

        function validateDocumentText() {
            const text = documentText.value.trim();
            documentText.classList.remove('is-invalid', 'is-valid');
            validationFeedback.textContent = '';
            if (text.length === 0) return false;
            if (text.length < 100) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'Document text must be at least 100 characters.';
                return false;
            }
            if (text.length > 50000) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'Document text exceeds 50,000 characters.';
                return false;
            }
            const keywords = ['agreement', 'contract', 'party', 'parties', 'terms', 'conditions', 'shall', 'legal'];
            const found = keywords.filter(k => text.toLowerCase().includes(k));
            if (found.length < 2) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'This doesn\'t appear to be a legal document.';
                return false;
            }
            documentText.classList.add('is-valid');
            return true;
        }

        function handleFileSelection(file) {
            const maxSize = 10 * 1024 * 1024;
            const allowedExtensions = ['.pdf', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                showFileError('Please select a PDF or TXT file.');
                return;
            }
            if (file.size > maxSize) {
                showFileError('File size must be less than 10MB.');
                return;
            }
            if (file.size === 0) {
                showFileError('File appears to be empty.');
                return;
            }
            showFileSuccess(file);
            documentText.value = '';
            updateCharCount();
            documentText.classList.remove('is-invalid', 'is-valid');
        }

        function showFileSuccess(file) {
            fileUploadContent.style.display = 'none';
            fileUploadSuccess.style.display = 'block';
            uploadedFileName.textContent = file.name;
            const sizeText = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
            uploadedFileInfo.textContent = `${sizeText} • Ready for analysis`;
            fileUploadArea.classList.remove('error');
        }

        function showFileError(message) {
            alert(message); // Simple alert for errors
            clearFile();
        }

        window.clearFile = function () {
            fileInput.value = '';
            fileUploadContent.style.display = 'block';
            fileUploadSuccess.style.display = 'none';
        };

        // --- EVENT LISTENERS (PRESERVED FROM YOUR CODE) ---
        documentText.addEventListener('input', () => { updateCharCount(); validateDocumentText(); });
        fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
        fileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadArea.classList.remove('dragover'); });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileSelection(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelection(e.target.files[0]);
        });
        
        // --- *** KEY CHANGE: CONSOLIDATED ASYNC FORM SUBMISSION *** ---
        form.addEventListener('submit', async function (e) {
            // 1. ALWAYS prevent the default browser submission
            e.preventDefault();
            jsErrorAlert.style.display = 'none';

            // 2. Perform final validation check
            const hasFile = fileInput.files.length > 0;
            const hasText = documentText.value.trim().length > 0;
            
            if (!hasFile && !hasText) {
                documentText.classList.add('is-invalid');
                validationFeedback.textContent = 'Please either upload a file or paste document text.';
                documentText.focus();
                return;
            }
            if (hasText && !validateDocumentText()) {
                documentText.focus();
                return;
            }
            
            // 3. Show loading state (assumes showLoading() is in a global script like app.js)
            showLoading();
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Analyzing...`;

            // 4. Create FormData and send the request via fetch
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // 5. Success: The backend sent the results page. Replace current page content.
                    const resultHtml = await response.text();
                    document.open();
                    document.write(resultHtml);
                    document.close();
                } else {
                    // 6. Server Error: Display the error from the server.
                    const errorText = await response.text();
                    jsErrorAlert.textContent = `Analysis failed: ${errorText}`;
                    jsErrorAlert.style.display = 'block';
                    hideLoading(); // Hide spinner on error
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="bi bi-search"></i> Analyze Document';
                }
            } catch (error) {
                // 7. Network Error: Handle cases where the server can't be reached.
                console.error('Submission Fetch Error:', error);
                jsErrorAlert.textContent = 'A network error occurred. Please check your connection and try again.';
                jsErrorAlert.style.display = 'block';
                hideLoading(); // Hide spinner on error
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="bi bi-search"></i> Analyze Document';
            }
        });

        // Initial state setup
        updateCharCount();
    });
</script>
{% endblock %}