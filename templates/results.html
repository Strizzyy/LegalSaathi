{% extends "base.html" %}

{% block title %}Analysis Results - LegalSaathi{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
            <h2 class="mb-2 mb-sm-0">ðŸ“‹ Document Analysis Results</h2>
            <a href="/" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i>
                <span class="d-none d-sm-inline">Analyze Another Document</span>
                <span class="d-inline d-sm-none">New Analysis</span>
            </a>
        </div>

        {% if file_info or warnings or classification %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Document Information</h5>
            </div>
            <div class="card-body">
                {% if file_info %}
                <div class="mb-3">
                    <h6><i class="bi bi-file-earmark"></i> File Details:</h6>
                    <p class="mb-1"><strong>Filename:</strong> {{ file_info.filename }}</p>
                    <p class="mb-1"><strong>Size:</strong> {{ "%.1f"|format(file_info.size / (1024 * 1024)) }}MB</p>
                </div>
                {% endif %}

                {% if classification %}
                <div class="mb-3">
                    <h6><i class="bi bi-tag"></i> Document Classification:</h6>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary me-2">{{ classification.document_type.value.replace('_', ' ').title() }}</span>
                        <span class="text-muted">Confidence: {{ "%.0f"|format(classification.confidence * 100) }}%</span>
                    </div>
                </div>
                {% endif %}

                {% if warnings %}
                <div class="mb-0">
                    <h6><i class="bi bi-exclamation-triangle text-warning"></i> Processing Notes:</h6>
                    {% for warning in warnings %}
                    <div class="alert alert-warning py-2 mb-2">
                        <small>{{ warning }}</small>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <div id="jsErrorAlert" class="alert alert-danger" role="alert" style="display: none;"></div>

        {% set risk_class = 'danger' if analysis.overall_risk.level == 'RED' else ('warning' if analysis.overall_risk.level == 'YELLOW' else 'success') %}
        <div class="card mb-4 border-{{ risk_class }}">
            <div class="card-header bg-{{ risk_class }} text-white">
                <div class="d-flex align-items-center">
                    <span class="traffic-light-large {{ analysis.overall_risk.level.lower() }} me-3"></span>
                    <div>
                        <h3 class="mb-0">Overall Risk Assessment</h3>
                        <small class="opacity-75">Complete document analysis summary</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-{{ risk_class }} mb-3">
                    <p class="lead mb-0" id="analysisSummary">{{ analysis.summary }}</p>
                </div>
                </div>
        </div>

        <div class="card mb-4">
             </div>

        {% if analysis.analysis_results %}
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-search"></i> Detailed Clause Analysis</h4>
                <small class="text-muted">Each clause analyzed for risk level and plain language explanation</small>
            </div>
            <div class="card-body">
                {% for result in analysis.analysis_results %}
                {% set clause_risk_class = 'danger' if result.risk_level.level == 'RED' else ('warning' if result.risk_level.level == 'YELLOW' else 'success') %}
                <div class="clause-analysis-item border border-{{ clause_risk_class }} rounded p-3 mb-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center">
                            <span class="traffic-light-medium {{ result.risk_level.level.lower() }} me-3"></span>
                            <div>
                                <h5 class="mb-0">Clause #{{ loop.index }}</h5>
                                <small class="text-muted">Risk Assessment</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-{{ clause_risk_class }} fs-6 mb-1">
                                {{ result.risk_level.level }} RISK
                            </span>
                            <br>
                            <small class="text-muted">
                                Score: {{ "%.0f"|format(result.risk_level.score * 100) }}% |
                                Confidence: {{ result.risk_level.confidence_percentage }}%
                            </small>
                        </div>
                    </div>

                    <div class="alert alert-{{ clause_risk_class }} mb-3">
                        <h6 class="alert-heading"><i class="bi bi-chat-text"></i> What This Means:</h6>
                        <p class="mb-0">{{ result.plain_explanation }}</p>
                    </div>

                    <div class="row">
                        <div class="col-12 col-lg-6 mb-3">
                             <h6><i class="bi bi-info-circle"></i> Legal Implications:</h6>
                             </div>
                        <div class="col-12 col-lg-6 mb-3">
                            <h6><i class="bi bi-lightbulb"></i> Recommended Actions:</h6>
                            </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-robot"></i> AI-Powered Features</h4>
                <small class="text-muted">Get additional help with translation and clarification</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 col-md-6 mb-3">
                        <div class="feature-card p-3 border rounded">
                            <h6><i class="bi bi-translate"></i> Multi-language Support</h6>
                            <p class="small text-muted mb-3">Translate the overall summary to your preferred language.</p>
                            <select class="form-select form-select-sm mb-2" id="targetLanguage">
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="hi">Hindi</option>
                                <option value="zh">Chinese</option>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" id="translateBtn" onclick="translateSummary()">
                                <i class="bi bi-translate"></i> Translate Summary
                            </button>
                            <div id="translationResult" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <div class="feature-card p-3 border rounded">
                            <h6><i class="bi bi-chat-dots"></i> AI Clarification</h6>
                            <p class="small text-muted mb-3">Ask questions about the document or specific terms.</p>
                            <input type="text" class="form-control form-control-sm mb-2" id="clarificationQuestion" placeholder="e.g., What is 'subletting'?">
                            <button class="btn btn-outline-success btn-sm" id="clarifyBtn" onclick="askClarification()">
                                <i class="bi bi-chat-dots"></i> Ask AI
                            </button>
                            <div id="clarificationResult" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
             </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- AI FEATURES SCRIPT ---

// Function to safely display errors
function showAIError(message) {
    const errorAlert = document.getElementById('jsErrorAlert');
    errorAlert.textContent = message;
    errorAlert.style.display = 'block';
    setTimeout(() => { errorAlert.style.display = 'none'; }, 5000);
}

async function translateSummary() {
    const translateBtn = document.getElementById('translateBtn');
    const targetLanguage = document.getElementById('targetLanguage').value;
    // --- FIX: Safely get text from the DOM, don't inject with Jinja ---
    const summaryText = document.getElementById('analysisSummary').textContent;

    // --- UX: Show loading state on button ---
    const originalBtnHtml = translateBtn.innerHTML;
    translateBtn.disabled = true;
    translateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Translating...`;

    try {
        const response = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: summaryText,
                target_language: targetLanguage
            })
        });

        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

        const data = await response.json();
        if (data.success) {
            const resultDiv = document.getElementById('translationResult');
            resultDiv.innerHTML = `<div class="alert alert-info py-2"><small><strong>${data.language_name}:</strong> ${data.translated_text}</small></div>`;
            resultDiv.style.display = 'block';
        } else {
            throw new Error(data.error || 'Translation failed.');
        }
    } catch (error) {
        console.error('Translation error:', error);
        showAIError('Translation service is currently unavailable. Please try again later.');
    } finally {
        // --- UX: Restore button state ---
        translateBtn.disabled = false;
        translateBtn.innerHTML = originalBtnHtml;
    }
}

async function askClarification() {
    const clarifyBtn = document.getElementById('clarifyBtn');
    const questionInput = document.getElementById('clarificationQuestion');
    const question = questionInput.value;

    if (!question.trim()) {
        showAIError('Please enter a question.');
        return;
    }

    // --- UX: Show loading state ---
    const originalBtnHtml = clarifyBtn.innerHTML;
    clarifyBtn.disabled = true;
    clarifyBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Asking...`;

    try {
        const response = await fetch('/api/clarify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question: question,
                context: { // Context can be sent for more specific answers
                    risk_level: '{{ analysis.overall_risk.level }}',
                    summary: '{{ analysis.summary | truncate(200) }}'
                }
            })
        });

        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

        const data = await response.json();
        if (data.success) {
            const resultDiv = document.getElementById('clarificationResult');
            resultDiv.innerHTML = `<div class="alert alert-success py-2"><small>${data.response}</small></div>`;
            resultDiv.style.display = 'block';
        } else {
            throw new Error(data.error || 'Clarification failed.');
        }
    } catch (error) {
        console.error('Clarification error:', error);
        showAIError('AI clarification service is unavailable. Please try again later.');
    } finally {
        // --- UX: Restore button state ---
        clarifyBtn.disabled = false;
        clarifyBtn.innerHTML = originalBtnHtml;
    }
}
</script>
{% endblock %}